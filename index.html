<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MelodyMethod - Portal del Estudiante</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #1a3a5a; --accent: #f39c12; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: #333; overflow: hidden; }
        
        /* BARRA LATERAL */
        .sidebar { width: 300px; background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 25px; text-align: center; background: rgba(0,0,0,0.2); }
        .logo { color: var(--accent); font-size: 1.8rem; font-weight: bold; margin-bottom: 5px; }
        
        .btn-load { background: var(--accent); color: white; border: none; padding: 12px; margin: 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; }
        .btn-load:hover { transform: scale(1.02); }

        .lesson-list { flex: 1; overflow-y: auto; padding: 10px; }
        .lesson-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.05); }
        .lesson-item:hover { background: rgba(255,255,255,0.1); }
        .lesson-item.active { background: var(--accent); color: white; font-weight: bold; }

        /* CONTENIDO PRINCIPAL */
        .main-content { flex: 1; overflow-y: auto; padding: 40px; display: none; }
        .welcome-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; text-align: center; }

        .container { max-width: 1100px; margin: auto; display: grid; grid-template-columns: 1fr 320px; gap: 30px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        .line { border-left: 4px solid var(--accent); padding-left: 15px; margin-bottom: 25px; background: #fafafa; padding: 12px; border-radius: 0 8px 8px 0; }
        .en { font-size: 1.3rem; font-weight: bold; color: var(--primary); display: block; }
        .ph { font-size: 1.1rem; color: #7f8c8d; font-style: italic; display: block; margin: 4px 0; }
        .es { font-size: 1.05rem; color: #27ae60; display: block; }

        /* WIDGETS DERECHOS */
        .widget { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eee; margin-bottom: 20px; }
        .widget h4 { margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        
        .footer-note { text-align: center; font-size: 0.75rem; color: #aaa; margin-top: 20px; padding: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">MelodyMethod</div>
            <div id="student-name" style="font-size: 0.8rem; opacity: 0.8;">HOLA, ALUMNO</div>
        </div>

        <button class="btn-load" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-file-import"></i> CARGAR CURSO (.json)
        </button>
        <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFile(this)">

        <div class="lesson-list" id="lesson-list">
            </div>
    </div>

    <div class="welcome-screen" id="welcome">
        <i class="fas fa-music fa-4x" style="margin-bottom:20px; color:#ddd;"></i>
        <h2>¡Bienvenido Maestro!</h2>
        <p>Selecciona el archivo del curso para comenzar la clase.</p>
    </div>

    <div class="main-content" id="viewer">
        <div class="container">
            <div class="card">
                <h2 id="lesson-title" style="color:var(--primary); margin-top:0;"></h2>
                <audio id="audio" controls style="width:100%; margin-bottom:25px;"></audio>
                
                <div id="lyrics-area"></div>
            </div>

            <div class="sidebar-widgets">
                <div class="widget">
                    <h4><i class="fas fa-book"></i> Vocabulario</h4>
                    <p id="voc-txt" style="line-height: 1.6; white-space: pre-wrap;"></p>
                </div>
                <div class="widget">
                    <h4><i class="fas fa-globe"></i> Tip Cultural</h4>
                    <p id="tip-txt" style="line-height: 1.6; white-space: pre-wrap;"></p>
                </div>
                <div class="widget">
                    <h4><i class="fas fa-pen"></i> Práctica</h4>
                    <p id="prac-txt" style="line-height: 1.6; white-space: pre-wrap;"></p>
                </div>
            </div>
        </div>
        <div class="footer-note">©2026 DR Quiro Studio - Todos los derechos reservados.</div>
    </div>

    <script>
        let courseData = [];

        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const lessons = data.lecciones || data.lessons || [];
                    
                    if (lessons.length === 0) {
                        alert("No se encontraron lecciones en el archivo.");
                        return;
                    }

                    courseData = lessons;
                    document.getElementById('student-name').innerText = "ESTUDIANTE: " + (data.alumno || "ALUMNO").toUpperCase();
                    
                    renderLessonList();
                    
                    document.getElementById('welcome').style.display = 'none';
                    document.getElementById('viewer').style.display = 'block';
                    
                    // Mostrar la primera lección válida (la primera que no sea placeholder)
                    const firstIdx = lessons.findIndex(l => l.script && l.script.length > 10);
                    showLesson(firstIdx !== -1 ? firstIdx : 0);

                } catch(err) {
                    alert("Error al leer el archivo. Asegúrate de que sea un archivo JSON válido.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        function renderLessonList() {
            const list = document.getElementById('lesson-list');
            
            list.innerHTML = courseData.map((l, i) => {
                // FILTRO: Solo mostramos la lección si tiene contenido real en el script
                // Esto elimina las "Lección 6, 7, 8..." que están vacías
                if (!l.script || l.script.trim().length < 5) return '';

                return `
                    <div class="lesson-item" onclick="showLesson(${i})" id="li-${i}">
                        <i class="fas fa-music" style="margin-right:8px; opacity:0.6"></i> ${l.title}
                    </div>
                `;
            }).join('');
        }

        function showLesson(idx) {
            const l = courseData[idx];
            if (!l) return;

            // Actualizar estado activo en el menú
            document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`li-${idx}`);
            if(activeEl) activeEl.classList.add('active');

            // Cargar datos principales
            document.getElementById('lesson-title').innerText = l.title;
            const audio = document.getElementById('audio');
            audio.src = l.media || '';
            audio.load();

            // Procesar las líneas de la letra
            const lines = (l.script || "").split('\n');
            const phs = (l.ph || "").split('\n');
            const trs = (l.tr || "").split('\n');
            
            let html = '';
            lines.forEach((line, i) => {
                if(line.trim() === "") return;
                html += `
                    <div class="line">
                        <span class="en">${line}</span>
                        <span class="ph">${phs[i] || ''}</span>
                        <span class="es">${trs[i] || ''}</span>
                    </div>
                `;
            });

            document.getElementById('lyrics-area').innerHTML = html;
            
            // Llenar widgets
            document.getElementById('voc-txt').innerText = l.voc || 'No hay vocabulario para esta lección.';
            document.getElementById('tip-txt').innerText = l.tip || 'No hay tips culturales.';
            document.getElementById('prac-txt').innerText = l.prac || 'No hay tareas de práctica.';
            
            // Subir el scroll al cambiar de lección
            document.getElementById('viewer').scrollTop = 0;
        }
    </script>
</body>
</html>